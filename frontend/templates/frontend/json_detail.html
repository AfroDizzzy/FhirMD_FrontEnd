{% extends "frontend/base.html" %}
{% load static %}
{% block content %}
  <link rel="stylesheet" href="{% static 'frontend/jsonDetailStyle.css' %}" />
  {# Highlight.js CSS for a dark theme #}
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
  <main>
    <section class="content-section">
      <div class="sections-details-page-header fixed-element-top">
        <button type="button" onclick="window.history.back();" class="back-button">
          <i class="back-nav-icon"></i>
        </button>
        <h2 class="sections-details-page-header-text">{{ resource_type }} - {{ DisplayName }}</h2>
        <div class="json-details-heading-div">
          <button id="downloadJson" class="download-button">Download JSON</button>
        </div>
      </div>
      <div class="metadata-information">
        <button type="button" class="collapsible-button collapsed">Metadata</button>
        <div class="item-metadata collapsed">
          {% if not file_metadata %}<h6 class="metadata-label">No Metadata Avaliable</h6>{% endif %}
          {% if file_metadata.Author %}
            <div class="metadata-field">
              <h6 class="metadata-label">Author:</h6>
              <p class="metadata-value">{{ file_metadata.Author|escape }}</p>
            </div>
          {% endif %}
          {# Implementation Guides Section #}
          {% if file_metadata.Parsed_IG_Notations %}
            <div class="metadata-field">
              <h6 class="metadata-label">Implementation Guides:</h6>
              <ul class="ig-list">
                {% for ig in file_metadata.Parsed_IG_Notations %}
                  <li class="ig-item">
                    {{ ig.name|escape }}
                    {% if ig.version %}: {{ ig.version|escape }}{% endif %}
                  </li>
                {% endfor %}
              </ul>
            </div>
          {% elif file_metadata.IG or file_metadata.IG_Version %}
            {# Fallback to legacy IG fields for transition period #}
            {% if file_metadata.IG %}
              <div class="metadata-field">
                <h6 class="metadata-label">IG:</h6>
                <p class="metadata-value">{{ file_metadata.IG|escape }}</p>
              </div>
            {% endif %}
            {% if file_metadata.IG_Version %}
              <div class="metadata-field">
                <h6 class="metadata-label">IG Version:</h6>
                <p class="metadata-value">{{ file_metadata.IG_Version|escape }}</p>
              </div>
            {% endif %}
          {% endif %}
          {% if file_metadata.PHI_Check %}
            <div class="metadata-field">
              <h6 class="metadata-label">PHI Check:</h6>
              <p class="metadata-value">{{ file_metadata.PHI_Check|escape }}</p>
            </div>
          {% endif %}
          {% if file_metadata.Valid_Reference_values %}
            <div class="metadata-field">
              <h6 class="metadata-label">Valid Reference Values:</h6>
              <p class="metadata-value">{{ file_metadata.Valid_Reference_values|escape }}</p>
            </div>
          {% endif %}
          {% if file_metadata.Placeholder1 %}
            <div class="metadata-field">
              <h6 class="metadata-label">Placeholder1:</h6>
              <p class="metadata-value">{{ file_metadata.Placeholder1|escape }}</p>
            </div>
          {% endif %}
          {% if file_metadata.Placeholder2 %}
            <div class="metadata-field">
              <h6 class="metadata-label">Placeholder2:</h6>
              <p class="metadata-value">{{ file_metadata.Placeholder2|escape }}</p>
            </div>
          {% endif %}
          {% if file_metadata.Notes %}
            <div class="metadata-field">
              <h6 class="metadata-label">Notes:</h6>
              <p class="metadata-value">{{ file_metadata.Notes|escape }}</p>
            </div>
          {% endif %}
        </div>
      </div>
      {# The <pre><code> block for highlighted JSON #}
      <pre class="json-display"><code class="language-json">{{ pretty_json }}</code></pre>
    </section>
  </main>
  {# Highlight.js library #}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  {# Initialize Highlight.js after the content is loaded #}
  <script>
  document.addEventListener('DOMContentLoaded', (event) => {
    hljs.highlightAll();
  });
  </script>
  {# JavaScript for download button #}
  <script>
  document.getElementById('downloadJson').addEventListener('click', function() {
    const jsonData = `{{ pretty_json|escapejs }}`; // Use escapejs to handle quotes correctly
    const blob = new Blob([jsonData], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = '{{ resource_type|slugify }}-{{ item_id }}.json'; // Dynamic filename
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url); // Clean up the URL object
  });

  document.addEventListener('DOMContentLoaded', function() {
            const button = document.querySelector('.collapsible-button');
            const metadata = document.querySelector('.item-metadata');
            let isCollapsed = true;
            
            button.addEventListener('click', function() {
                isCollapsed = !isCollapsed;
                
                if (isCollapsed) {
                    metadata.classList.add('collapsed');
                    button.classList.add('collapsed');
                } else {
                    metadata.classList.remove('collapsed');
                    button.classList.remove('collapsed');
                }
            });
        });
  </script>
{% endblock content %}
